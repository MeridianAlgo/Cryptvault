version: '3.8'

services:
  # ============================================================================
  # CryptVault Analysis Service
  # ============================================================================
  cryptvault:
    build:
      context: .
      dockerfile: Dockerfile
    image: cryptvault:latest
    container_name: cryptvault
    
    # Environment variables
    environment:
      # Application environment
      - CRYPTVAULT_ENV=${CRYPTVAULT_ENV:-production}
      
      # Logging configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/cryptvault.log
      
      # API Keys (optional - load from .env file)
      - CRYPTOCOMPARE_API_KEY=${CRYPTOCOMPARE_API_KEY:-}
      - ALPHA_VANTAGE_API_KEY=${ALPHA_VANTAGE_API_KEY:-}
      
      # Cache configuration
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - CACHE_TTL=${CACHE_TTL:-300}
      
      # ML configuration
      - ML_ENABLED=${ML_ENABLED:-true}
      - ML_MODEL_PATH=/app/data/models
      
      # Performance tuning
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    
    # Volume mounts for persistent data
    volumes:
      # Logs directory
      - ./logs:/app/logs
      
      # Data directory for models and cache
      - ./data:/app/data
      
      # Predictions cache
      - ./.cryptvault_predictions:/app/.cryptvault_predictions
      
      # Configuration files (optional override)
      - ./config:/app/config:ro
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Restart policy
    restart: unless-stopped
    
    # Network configuration
    networks:
      - cryptvault-network
    
    # Command override examples (uncomment to use):
    # command: ["BTC", "60", "1d"]                    # Analyze Bitcoin
    # command: ["--interactive"]                       # Interactive mode
    # command: ["--status"]                            # Check API status
    # command: ["--demo"]                              # Run demo

  # ============================================================================
  # Optional: Jupyter Notebook for Analysis
  # ============================================================================
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    image: cryptvault:latest
    container_name: cryptvault-jupyter
    
    environment:
      - CRYPTVAULT_ENV=development
      - JUPYTER_ENABLE_LAB=yes
    
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
      - ./notebooks:/app/notebooks
      - ./examples:/app/examples:ro
    
    ports:
      - "8888:8888"
    
    command: >
      bash -c "pip install jupyter jupyterlab &&
               jupyter lab --ip=0.0.0.0 --port=8888 --no-browser
               --allow-root --NotebookApp.token='' --NotebookApp.password=''"
    
    restart: unless-stopped
    
    networks:
      - cryptvault-network
    
    # Uncomment to enable Jupyter service
    profiles:
      - jupyter

# ============================================================================
# Networks
# ============================================================================
networks:
  cryptvault-network:
    driver: bridge
    name: cryptvault-network

# ============================================================================
# Volumes (optional named volumes instead of bind mounts)
# ============================================================================
volumes:
  cryptvault-logs:
    driver: local
  cryptvault-data:
    driver: local
  cryptvault-cache:
    driver: local
